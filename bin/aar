#!/usr/bin/python
"""
"""

import os
import sys
import argparse

from android_asset_resizer.resizer import AssetResizer

SOURCE_DENSITY_CHOICES = ('xxhdpi', 'xhdpi',)
PIL_FILTER_CHOICES = ('NEAREST', 'BILINEAR', 'BICUBIC', 'ANTIALIAS')

DEFAULT_DENSITY = 'xhdpi'
DEFAULT_FILTER = 'ANTIALIAS'
DEFAULT_OUT_PATH = os.getcwd()
DEFAULT_OUT_MODE = 0755

def uprint(msg):
    """
    Unbuffered print.
    """
    sys.stdout.write("%s\n" % msg)
    sys.stdout.flush()

def main():
    # Create our parser
    parser = argparse.ArgumentParser(description='Resize image assets for an Android project')

    # Set up our command-line arguments
    parser.add_argument('-d', '--density', default=DEFAULT_DENSITY, choices=SOURCE_DENSITY_CHOICES,
            help='the density of the source images')
    parser.add_argument('-p', '--prefix',
            help='a prefix to add to the filename')
    parser.add_argument('-f', '--filter', default=DEFAULT_FILTER, choices=PIL_FILTER_CHOICES,
            help='the image filter to use')
    parser.add_argument('-o', '--out',
            help='the path to the output directory')
    parser.add_argument('pattern', nargs='+',
            help='the path to the source images with matching pattern')

    # Get our arguments
    args = parser.parse_args()

    # Get our output directory
    if args.out:
        out_dir = os.path.abspath(args.out)

        if os.path.isfile(out_dir):
            parser.error('The specified out is not a directory!')
    else:
        out_dir = DEFAULT_OUT_PATH

    # Create the output directory if necessary
    try:
        os.makedirs(out_dir, DEFAULT_OUT_MODE)
    except OSError as e:
        pass

    # Get our resizer
    resizer = AssetResizer(out_dir, source_density=args.density,
            prefix=args.prefix, filter=args.filter)

    # Make our resource directories
    resizer.mkres()

    # Resize the assets
    for path in args.pattern:
        try:
            uprint('Resizing: %s' % path)
            resizer.resize(path)
        except IOError:
            uprint('IOError: %s' % path)


if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        sys.exit()
